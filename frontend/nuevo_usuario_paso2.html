<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>SmartBreathing - Personalización</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
  <link href="https://fonts.googleapis.com/css?family=Poppins:400,600,800&display=swap" rel="stylesheet">

  <!-- Shared Styles -->
  <link rel="stylesheet" href="css/nav.css">
  <link rel="stylesheet" href="css/styles.css">

  <style>
    body {
      background: var(--bg-gradient-vivid);
      background-size: 200% 200%;
      animation: gradientMove 12s ease-in-out infinite;
    }
    @keyframes gradientMove {
      0% {background-position: 0% 50%;}
      50% {background-position: 100% 50%;}
      100% {background-position: 0% 50%;}
    }

    .personalizacion-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - var(--nav-height) - 40px);
      padding: 20px;
    }

    .icono-campo {
      margin-right: 8px;
      color: #667eea;
    }

    .personal-header {
      text-align: center;
      margin-bottom: 18px;
    }

    .personal-header h1 {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.6em;
      margin-bottom: 6px;
      font-size: 1.8rem;
    }

    .personal-subtitle {
      margin: 0;
      font-size: 0.95rem;
      color: #878edb;
      opacity: 0.9;
    }

    .stepper {
      margin-bottom: 18px;
    }

    .user-form label {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .user-form select,
    .user-form input {
      margin-top: 4px;
    }

    /* Icono de ayuda ? con tooltip */
    .label-with-help {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .help-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid #a5b4fc;
      font-size: 0.75rem;
      font-weight: 700;
      color: #4f46e5;
      background: #eef2ff;
      cursor: default;
      position: relative;
    }

    .help-icon:hover {
      background: #e0e7ff;
    }

    .help-tooltip {
      position: absolute;
      top: 130%;
      left: 50%;
      transform: translateX(-50%) translateY(4px);
      background: #1f2933;
      color: #f9fafb;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 0.78rem;
      max-width: 260px;
      text-align: left;
      line-height: 1.35;
      box-shadow: 0 10px 25px rgba(15,23,42,0.4);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.18s ease, transform 0.18s ease;
      z-index: 50;
      pointer-events: none;
    }

    .help-tooltip::before {
      content: "";
      position: absolute;
      top: -6px;
      left: 50%;
      transform: translateX(-50%);
      border-width: 0 6px 6px 6px;
      border-style: solid;
      border-color: transparent transparent #1f2933 transparent;
    }

    .help-icon:hover .help-tooltip,
    .help-icon:focus-within .help-tooltip {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }

    .toast {
      visibility: hidden;
      min-width: 220px;
      color: white;
      background: #684CB2;
      text-align: center;
      border-radius: 8px;
      padding: 1.2em 1.4em;
      position: fixed;
      z-index: 100;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      transition: opacity 0.4s;
      opacity: 0;
      box-shadow: 0 5px 18px rgba(0,0,0,0.25);
      font-size: 0.95rem;
    }

    .toast.show {
      visibility: visible;
      opacity: 1;
    }

    #mensaje-usuario {
      margin-top: 14px;
      text-align: center;
    }

    input::placeholder {
      color: #cbd5e0;
    }
  </style>
</head>
<body>

  <script src="js/nav.js"></script>

  <div class="personalizacion-wrapper">
    <div class="card-centered" style="margin: 0; max-width: 520px;">
      <div class="stepper">
        <div class="step">1</div>
        <div class="bar"></div>
        <div class="step active">2</div>
      </div>

      <div class="personal-header">
        <h1><i class="fas fa-user-cog icono-campo"></i>Personalización</h1>
        <p class="personal-subtitle">
          Ajusta tu experiencia de entrenamiento según tus preferencias y objetivos.
        </p>
      </div>

      <form class="user-form" id="personalizacion-form" onsubmit="enviarUsuario(event)">
        <label for="deporte">
          <i class="fas fa-running icono-campo"></i>Preferencia de deporte:
        </label>
        <select id="deporte" required>
          <option value="">Selecciona</option>
          <option value="gimnasio">Gimnasio</option>
          <option value="natacion">Natación</option>
          <option value="atletismo">Atletismo</option>
        </select>

        <label for="fitness_level">
          <i class="fas fa-chart-line icono-campo"></i>Nivel deportivo:
        </label>
        <select id="fitness_level" required>
          <option value="">Selecciona</option>
          <option value="principiante">Principiante</option>
          <option value="intermedio">Intermedio</option>
          <option value="avanzado">Avanzado</option>
          <option value="profesional">Profesional</option>
        </select>

        <label for="objetivo">
          <i class="fas fa-bullseye icono-campo"></i>Objetivo deportivo:
        </label>
        <select id="objetivo" required>
          <option value="">Selecciona</option>
          <option value="perder_peso">Perder peso</option>
          <option value="ganar_masa_muscular">Ganar masa muscular</option>
          <option value="mantenerse_en_forma">Mantenerse en forma</option>
          <option value="ganar_peso">Ganar peso</option>
        </select>

        <label for="grado_exigencia" class="label-with-help">
          <i class="fas fa-fire icono-campo"></i>Grado de exigencia:
          <span class="help-icon" tabindex="0">
            ?
            <span class="help-tooltip">
              Define cómo te va a tratar tu entrenador virtual: el tono de los mensajes,
              lo permisivo que será con los fallos y el nivel de presión que aplicará
              para que cumplas tus entrenamientos.
            </span>
          </span>
        </label>
        <select id="grado_exigencia" required>
          <option value="">Selecciona</option>
          <option value="bajo">Bajo</option>
          <option value="moderado">Moderado</option>
          <option value="exigente">Exigente</option>
        </select>

        <label for="frecuencia">
          <i class="fas fa-calendar-alt icono-campo"></i>Frecuencia de entrenamiento (días/semana):
        </label>
        <select id="frecuencia" required>
          <option value="">Selecciona</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
        </select>

        <label for="tiempo_dedicable">
          <i class="fas fa-clock icono-campo"></i>Tiempo dedicable diario (minutos):
        </label>
        <input type="number" id="tiempo_dedicable" required min="10" max="300">

        <label for="equipamiento">
          <i class="fas fa-dumbbell icono-campo"></i>Equipamiento:
        </label>
        <select id="equipamiento" required>
          <option value="">Selecciona</option>
          <option value="instalaciones">En instalaciones</option>
          <option value="casa_con_equipamiento">Casa con equipamiento</option>
          <option value="casa_sin_equipamiento">Casa sin equipamiento</option>
        </select>

        <label for="sistema_recompensas" class="label-with-help">
          <i class="fas fa-gift icono-campo"></i>Sistema de Recompensas:
          <span class="help-icon" tabindex="0">
            ?
            <span class="help-tooltip">
              Se activará cuando completes tus entrenamientos o superes los objetivos
              marcados. Tu entrenador personal te propondrá la recompensa que hayas
              elegido para reforzar tu progreso.
            </span>
          </span>
        </label>
        <select id="sistema_recompensas" required>
          <option value="">Selecciona</option>
          <option value="comida">Comida</option>
          <option value="menos_ejercicio">Menos ejercicio</option>
          <option value="halago">Halago</option>
        </select>

        <button type="submit" class="btn-primary">
          <i class="fas fa-user-plus"></i> Crear usuario
        </button>
      </form>

      <div class="mensaje error-message" id="mensaje-usuario"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    function showToast(msg, color="#684CB2") {
      let t = document.getElementById("toast");
      t.textContent = msg;
      t.style.background = color;
      t.className = "toast show";
      setTimeout(() => t.className = "toast", 2000);
    }

    async function enviarUsuario(event) {
      event.preventDefault();
      const sistemaRecompensas = document.getElementById('sistema_recompensas').value;
      if (sistemaRecompensas === "") {
        showToast("Por favor, selecciona un tipo de recompensa.", "#e13333");
        return;
      }

      const paso1 = JSON.parse(localStorage.getItem('datosPerfilUsuario') || "{}");
      const peso = parseFloat(localStorage.getItem('pesoUsuarioTemp'));

      const userData = {
        nombre: paso1.nombre,
        apellido: paso1.apellido,
        codigo: paso1.codigo,
        condiciones_limitantes: paso1.condiciones_limitantes,
        genero: paso1.genero,
        edad: parseInt(paso1.edad || "0", 10),
        peso: peso,
        sport_preference: document.getElementById('deporte').value,
        fitness_level: document.getElementById('fitness_level').value,
        objetivo_deportivo: document.getElementById('objetivo').value,
        grado_exigencia: document.getElementById('grado_exigencia').value,
        frecuencia_entrenamiento: parseInt(document.getElementById('frecuencia').value, 10),
        tiempo_dedicable_diario: parseInt(document.getElementById('tiempo_dedicable').value, 10),
        equipamiento: document.getElementById('equipamiento').value,
        sistema_recompensas: sistemaRecompensas
      };

      try {
        const response = await fetch('http://localhost:8000/api/users/create', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(userData)
        });
        const result = await response.json();

        if (response.ok && result.user_id) {
          if (peso && !isNaN(peso)) {
            const medicion = {
              idUsuario: result.user_id,
              valores: { peso: peso },
              fecha: new Date().toISOString(),
              quien_realizo: result.user_id
            };
            await fetch('http://localhost:8000/api/mediciones', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(medicion)
            });
          }
          showToast("Usuario creado correctamente", "#4CAF50");
          setTimeout(() => window.location.href = "menu.html", 1100);
        } else {
          showToast("Error: " + (result.detail || "No se pudo crear el usuario."), "#e13333");
          console.error(result);
        }
      } catch (error) {
        showToast("Error de conexión. Inténtalo de nuevo.", "#e13333");
        console.error(error);
      }
    }
  </script>
</body>
</html>
