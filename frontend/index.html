<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartBreathing - Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
  <link href="https://fonts.googleapis.com/css?family=Poppins:400,600,800&display=swap" rel="stylesheet">
  
  <!-- Shared Styles -->
  <link rel="stylesheet" href="css/nav.css">
  <link rel="stylesheet" href="css/styles.css">

  <style>
    /* Fondo animado suave, en línea con el resto */
    body {
        background: var(--bg-gradient-light);
        background-size: 200% 200%;
        animation: subtleGradient 18s ease-in-out infinite;
        font-family: 'Poppins', sans-serif;
    }

    .dashboard-container { 
        max-width: 1120px; 
        margin: 40px auto; 
        background: var(--card-bg); 
        border-radius: var(--radius-lg); 
        box-shadow: var(--shadow-soft); 
        padding: 40px; 
        min-height: 90vh; 
        backdrop-filter: blur(10px);
        transition: box-shadow 0.25s ease, transform 0.25s ease;
    }

    .dashboard-container:hover {
        box-shadow: 0 18px 44px rgba(0, 0, 0, 0.12);
        transform: translateY(-4px);
    }
    
    .header { 
        text-align: center; 
        margin-bottom: 24px; 
    }

    .header-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin: 0 auto 10px auto;
        background: var(--primary-gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        box-shadow: 0 12px 26px rgba(102,126,234,0.4);
    }

    .header-icon i { font-size: 1.6rem; }

    .header h1 { 
        color: #6066dc; 
        font-weight: 900; 
        font-size: 2.1em; 
        margin-bottom: 5px; 
        margin-top: 5px; 
        letter-spacing: .01em; 
    }

    .header p { 
        color: #474b6a; 
        font-weight: 600; 
        letter-spacing: .01em; 
        margin-bottom: 8px; 
        margin-top: 0; 
        font-size: 1.05em; 
    }
    
    .manual-form { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 15px; 
        justify-content: center; 
        align-items: center; 
        margin-bottom: 38px; 
        margin-top: 20px; 
        font-size: 1.02em; 
        background: #f9fafe; 
        padding: 25px; 
        border-radius: var(--radius-md); 
        box-shadow: 0 2px 15px rgba(0,0,0,0.03);
    }

    .manual-form label { 
        font-weight: 700; 
        letter-spacing: .01em; 
        color: #434894; 
        margin:0 4px 0 0; 
    }

    .manual-form input[type="number"] { 
        padding: 10px; 
        font-size: 1em; 
        border-radius: 10px; 
        border: 1px solid #bbc6f8; 
        outline: none; 
        max-width: 80px; 
        min-width:60px; 
        text-align:right; 
        background: #fff; 
        margin-right:14px;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
    }

    .manual-form input[type="number"]:hover {
        border-color: #8fa2ff;
        box-shadow: 0 4px 10px rgba(143,162,255,0.25);
        transform: translateY(-1px);
    }

    .manual-form button { 
        padding: 12px 22px; 
        font-size: 1em; 
        border-radius: 14px; 
        border: none; 
        font-weight: bold; 
        color: white; 
        background: var(--primary-gradient); 
        cursor: pointer; 
        margin-left:10px; 
        transition: all 0.2s;
    }

    .manual-form button:hover { 
        transform: translateY(-2px); 
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); 
        filter: brightness(1.05);
    }
    
    .metrics-grid { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 24px; 
        justify-content: center; 
        margin: 25px 0 28px 0; 
    }

    .metric-card { 
        background: #f9fafe; 
        border-radius: 21px; 
        min-width: 211px; 
        min-height: 120px; 
        padding: 15px 20px 17px 20px; 
        box-shadow: 0 4px 16px rgba(0,0,0,0.04); 
        text-align: center; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        position: relative; 
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        flex: 1 1 250px; /* Responsive flex */
        max-width: 340px;
    }

    .metric-card:hover { 
        transform: translateY(-4px); 
        box-shadow: 0 10px 26px rgba(0,0,0,0.08); 
        background:#ffffff;
    }

    .metric-title { 
        font-size: 1.02em; 
        font-weight: 800; 
        color: #554ab8; 
        margin-bottom: 4px; 
        letter-spacing: .02em; 
    }

    .metric-title i {
        margin-right: 6px;
    }

    .metric-value { 
        font-size: 2.05em; 
        font-weight: bold; 
        margin: 5px 0 2px 0; 
        color:#293265; 
    }

    .metric-unit { 
        position: absolute; 
        right: 13px; 
        top: 9px; 
        color: #8797e8; 
        font-size: 1.01em; 
        font-weight: 800; 
    }
    
    .status-indicator { 
        display: inline-block; 
        width: 18px; 
        height: 18px; 
        border-radius: 100%; 
        margin-right: 7px; 
        vertical-align: middle; 
        border: 2px solid #bfc9ec;
    }

    .status-good {background: #7af77a; border-color: #48e248;}
    .status-warning {background: #FFEA6C; border-color:#f7ca33;}
    .status-danger {background: #f77070; border-color: #e94c4c;}
    
    .co2-value-box, .hum-value-box { 
        font-size: 1.1em; 
        font-weight:700;  
        background: #ecf1ff; 
        border-radius:9px; 
        box-shadow:0 1.5px 7px #9bb0e42a;
        margin:0 3px; 
        min-width:60px; 
        padding:7px 11px; 
        color:#444aaf;
        transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
        text-align:center;
    }

    .co2-value-box:hover, .hum-value-box:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(123,139,238,0.35);
        background:#dde5ff;
    }

    .chart-container { 
        background: #fff; 
        border-radius: 17px; 
        box-shadow: 0 6px 28px rgba(0,0,0,0.06); 
        padding: 26px; 
        margin-bottom: 28px; 
        margin-top: 28px; 
        max-width: 1000px;
        margin-left: auto; 
        margin-right: auto;
        transition: box-shadow 0.25s ease, transform 0.25s ease;
    }

    .chart-container canvas {
      height: 420px !important;
      max-height: 480px;
      width: 100% !important;
    }

    .chart-container:hover {
        box-shadow: 0 18px 42px rgba(0,0,0,0.09);
        transform: translateY(-3px);
    }

    .chart-title {
        font-weight:bold; 
        color:#6066dc; 
        margin-bottom:14px;
        display:flex;
        align-items:center;
        gap:8px;
        font-size:1.05rem;
    }

    .chart-title i {
        font-size:1rem;
    }
    
    @media (max-width: 900px) {
      .chart-container { max-width: 100%; padding: 18px; }
    }
    @media (max-width: 650px) { 
        .metrics-grid {
            flex-direction:column; 
            align-items:center;
        } 
        .dashboard-container {
            padding: 20px;
            margin: 20px auto;
        }
        .manual-form {
            padding: 18px;
        }
        .chart-container {
          max-width: 100%;
        }
    }
  </style>
</head>
<body>
  
  <script src="js/nav.js"></script>

  <div class="dashboard-container">
    <div class="header">
      <div class="header-icon">
        <i class="fas fa-heartbeat"></i>
      </div>
      <h1>SmartBreathing</h1>
      <p>Dashboard de Monitoreo Fisiológico</p>
      <div style="margin-top: 8px; font-size: 1.13em; color: #444aaf; font-weight: 600;" id="welcome-box">
        Bienvenido de nuevo
      </div>
    </div>
    
    <form class="manual-form" id="manualForm" autocomplete="off">
      <label for="spo2-input">SpO₂ (%)</label>
      <input type="number" id="spo2-input" name="spo2" min="50" max="100" step="0.1" required placeholder="%"/>
      <label for="cintura-input">Cintura (cm)</label>
      <input type="number" id="cintura-input" name="cintura" min="20" max="250" step="0.1" required placeholder="cm"/>
      
      <div style="width:100%; display:flex; justify-content:center; margin-top:12px;">
        <button type="submit">Guardar datos</button>
      </div>
    </form>
    
    <div id="msg-box"></div>
    
    <!-- Row 1: SpO2, BPM, Grasa -->
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-title"><i class="fas fa-lungs"></i> Saturación de Oxígeno (SpO₂)</div>
        <div class="metric-value" id="spo2-value">--</div>
        <div class="metric-unit">%</div>
        <div class="status-indicator status-good" id="spo2-status"></div>
        <span id="spo2-text">Normal</span>
      </div>

      <div class="metric-card">
        <div class="metric-title"><i class="fas fa-heart"></i> Frecuencia Cardíaca (bpm)</div>
        <div class="metric-value" id="hr-value">--</div>
        <div class="status-indicator status-good" id="hr-status"></div>
        <span id="hr-text">Normal</span>
      </div>

      <div class="metric-card">
        <div class="metric-title"><i class="fas fa-user-md"></i> % Grasa Corporal (YMCA)</div>
        <div class="metric-value" id="grasa-value">--</div>
        <div class="status-indicator status-good" id="grasa-status"></div>
        <span id="grasa-text">---</span>
      </div>
    </div>

    <!-- Row 2: CO2 (Stabilized) -->
    <div class="metrics-grid" style="margin-top: -10px;">
      <div class="metric-card metric-co2-all" style="width: 100%; max-width: 1000px;">
        <div class="metric-title">
          CO₂ (ppm) 
          <span style="color:#869;margin-left:4px; font-size:0.98em;font-weight:400;">
            (últimas lecturas)
          </span>
        </div>
        <div style="display:flex; justify-content:center; gap:15px; margin-top:10px; flex-wrap:wrap;">
          <div><div class="co2-value-box" id="co2-1-value">--</div></div>
          <div><div class="co2-value-box" id="co2-2-value">--</div></div>
          <div><div class="co2-value-box" id="co2-3-value">--</div></div>
          <div><div class="co2-value-box" id="co2-4-value">--</div></div>
          <div><div class="co2-value-box" id="co2-5-value">--</div></div>
        </div>
      </div>
    </div>

    <!-- Row 3: Humedad (Stabilized) -->
    <div class="metrics-grid" style="margin-top: -10px;">
      <div class="metric-card metric-hum-all" style="width: 100%; max-width: 1000px;">
        <div class="metric-title">
          Humedad (%) 
          <span style="color:#869;margin-left:4px; font-size:0.98em;font-weight:400;">
            (últimas lecturas)
          </span>
        </div>
        <div style="display:flex; justify-content:center; gap:15px; margin-top:10px; flex-wrap:wrap;">
          <div><div class="hum-value-box" id="hum-1-value">--</div></div>
          <div><div class="hum-value-box" id="hum-2-value">--</div></div>
          <div><div class="hum-value-box" id="hum-3-value">--</div></div>
          <div><div class="hum-value-box" id="hum-4-value">--</div></div>
          <div><div class="hum-value-box" id="hum-5-value">--</div></div>
        </div>
      </div>
    </div>
    
    <!-- New Chart A: CO2 -->
    <div class="chart-container" id="co2-chart-container">
      <div class="chart-title">
        <i class="fas fa-chart-line"></i> Evolución CO₂ (ppm) – Raw + puntos estabilizados
      </div>
      <div id="co2-no-data" style="display:none; text-align:center; padding: 40px; color: #777; font-weight: 600; font-size: 1.1em; background: #f8f9fc; border-radius: 12px;">
         Todavía no hay mediciones de CO₂ para mostrar
      </div>
      <canvas id="co2Chart" width="1000" height="320"></canvas>
    </div>

    <!-- New Chart B: Humedad -->
    <div class="chart-container" id="hum-chart-container">
      <div class="chart-title">
        <i class="fas fa-tint"></i> Evolución Humedad (%) – Raw + puntos estabilizados
      </div>
      <div id="hum-no-data" style="display:none; text-align:center; padding: 40px; color: #777; font-weight: 600; font-size: 1.1em; background: #f8f9fc; border-radius: 12px;">
         Todavía no hay mediciones de Humedad para mostrar
      </div>
      <canvas id="humChart" width="1000" height="320"></canvas>
    </div>

    <!-- ECG CHART -->
    <div class="chart-container" id="ecg-container">
      <div class="chart-title">
        <i class="fas fa-wave-square"></i> ECG (últimos 5 segundos)
      </div>
      
      <div id="ecg-no-data" style="display:none; text-align:center; padding: 40px; color: #777; font-weight: 600; font-size: 1.1em; background: #f8f9fc; border-radius: 12px;">
        No hay datos de ECG disponibles todavía.
      </div>

      <canvas id="ecgChart" width="1000" height="320"></canvas>
    </div>
    
    <div style="text-align:center;margin:2em 0 0.4em 0;color:#4162ea;font-size:1.05em;font-weight:600;">
      Gestor de rutinas y recomendaciones disponible a través del Bot de Telegram.
    </div>
  </div>
  
  <script>
    document.addEventListener("DOMContentLoaded", async function() {
      const userId = localStorage.getItem('user_id');
      const userName = localStorage.getItem('user_name');
      if (!userId) {
        window.location.href = "login.html";
        return;
      }
      document.getElementById('welcome-box').textContent = `Bienvenido de nuevo${userName ? ", " + userName : ""}`;

      // Notify backend that this user is the "current ECG user"
      try {
        await fetch('http://localhost:8000/api/ecg/current-user', {
          method: 'POST',
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: userId })
        });
      } catch (e) {
        console.warn("Failed to notify backend of current ECG user:", e);
      }

      let userAge = null, userGender = null;
      try {
        const resp = await fetch(`http://localhost:8000/api/users/by_id/${userId}`);
        if (resp.ok) {
          const userData = await resp.json();
          userAge = Number(userData.edad) || null;
          userGender = (userData.genero || userData.genero_usuario || '').toLowerCase();
        }
      } catch(e) {}


      async function obtenerValoresActuales() {
        try {
          const response = await fetch('http://localhost:8000/api/mediciones?user_id=' + encodeURIComponent(userId));
          if (!response.ok) throw new Error("Error al cargar datos");
          const mediciones = await response.json();
          if (mediciones.length > 0 && mediciones[0].valores) {
            return mediciones[0].valores;
          }
        } catch (e) {}
        return {};
      }


      function spo2ColorEstado(valor) {
        if (valor >= 95) return { estado: 'Normal', color: 'status-good' };
        if (valor >= 90) return { estado: 'Precaución', color: 'status-warning' };
        return { estado: 'Grave', color: 'status-danger' };
      }


      function rangoGrasaYColor(grasa, sexo, edad) {
        if (grasa > 30) {
           return { nivel: 'Alerta', color: 'status-danger' };
        }
        
        let normalMin, normalMax, warningMax;
        if (sexo === 'mujer') {
          if (edad >= 20 && edad < 40)      { normalMin = 21; normalMax = 33; warningMax = 39; }
          else if (edad >= 40 && edad <= 59){ normalMin = 23; normalMax = 34; warningMax = 40; }
          else                              { normalMin = 23; normalMax = 35; warningMax = 40; }
        } else if (sexo === 'hombre') {
          if (edad >= 20 && edad < 40)      { normalMin = 8;  normalMax = 20; warningMax = 25; }
          else if (edad >= 40 && edad <= 59){ normalMin = 11; normalMax = 22; warningMax = 28; }
          else                              { normalMin = 11; normalMax = 22; warningMax = 28; }
        } else { return { nivel: '---', color: 'status-warning' }; }


        if(grasa < normalMin) return { nivel: 'Precaución', color: 'status-warning' };
        if(grasa <= normalMax) return { nivel: 'Normal', color: 'status-good' };
        if(grasa <= warningMax) return { nivel: 'Moderado', color: 'status-warning' };
        return { nivel: 'Grave', color: 'status-danger' };
      }
      
      function bpmColorEstado(bpm) {
         if (bpm < 50) return { estado: 'Bradicardia', color: 'status-warning' };
         if (bpm > 100) return { estado: 'Taquicardia', color: 'status-danger' };
         return { estado: 'Normal', color: 'status-good' };
      }
      
      function format2Dec(val) {
          if (val === undefined || val === null || val === '') return '--';
          return Number(val).toFixed(2);
      }

      function actualizarMetricas(valores) {
        // SpO₂
        const spo2Val = valores.spo2 !== undefined ? Number(valores.spo2).toFixed(1) : '--';
        document.getElementById('spo2-value').textContent = spo2Val;
        const spo2Est = spo2ColorEstado(Number(valores.spo2));
        ['status-good','status-warning','status-danger'].forEach(c => document.getElementById('spo2-status').classList.remove(c));
        document.getElementById('spo2-status').classList.add(spo2Est.color);
        document.getElementById('spo2-text').textContent = spo2Est.estado;


        // % Grasa (YMCA)
        const grasaVal = valores.grasa_porc !== undefined ? Number(valores.grasa_porc).toFixed(2) : '--';
        document.getElementById('grasa-value').textContent = grasaVal;
        const grasaEst = (valores.grasa_porc !== undefined && userGender && userAge)
          ? rangoGrasaYColor(Number(valores.grasa_porc), userGender, userAge)
          : {nivel: '---', color: 'status-warning'};
        ['status-good','status-warning','status-danger'].forEach(c => document.getElementById('grasa-status').classList.remove(c));
        document.getElementById('grasa-status').classList.add(grasaEst.color);
        document.getElementById('grasa-text').textContent = grasaEst.nivel;
        
        // Frecuencia Cardíaca (BPM)
        const bpmVal = valores.bpm !== undefined ? Math.round(Number(valores.bpm)) : '--';
        document.getElementById('hr-value').textContent = bpmVal;
        
        if (valores.bpm !== undefined) {
           const bpmEst = bpmColorEstado(Number(valores.bpm));
           ['status-good','status-warning','status-danger'].forEach(c => document.getElementById('hr-status').classList.remove(c));
           document.getElementById('hr-status').classList.add(bpmEst.color);
           document.getElementById('hr-text').textContent = bpmEst.estado;
        } else {
           ['status-good','status-warning','status-danger'].forEach(c => document.getElementById('hr-status').classList.remove(c));
           document.getElementById('hr-status').classList.add('status-good');
           document.getElementById('hr-text').textContent = 'Normal';
        }


        // CO₂ (2 decimals)
        document.getElementById('co2-1-value').textContent = format2Dec(valores.co2_1);
        document.getElementById('co2-2-value').textContent = format2Dec(valores.co2_2);
        document.getElementById('co2-3-value').textContent = format2Dec(valores.co2_3);
        document.getElementById('co2-4-value').textContent = format2Dec(valores.co2_4);
        document.getElementById('co2-5-value').textContent = format2Dec(valores.co2_5);

        // HUMEDAD (2 decimals)
        document.getElementById('hum-1-value').textContent = format2Dec(valores.hum_1) !== '--' ? format2Dec(valores.hum_1) + ' %' : '--';
        document.getElementById('hum-2-value').textContent = format2Dec(valores.hum_2) !== '--' ? format2Dec(valores.hum_2) + ' %' : '--';
        document.getElementById('hum-3-value').textContent = format2Dec(valores.hum_3) !== '--' ? format2Dec(valores.hum_3) + ' %' : '--';
        document.getElementById('hum-4-value').textContent = format2Dec(valores.hum_4) !== '--' ? format2Dec(valores.hum_4) + ' %' : '--';
        document.getElementById('hum-5-value').textContent = format2Dec(valores.hum_5) !== '--' ? format2Dec(valores.hum_5) + ' %' : '--';
      }

      // -------------- NUEVOS GRÁFICOS CO2 & HUMEDAD ----------------
      let co2Chart = null;
      let humChart = null;

      async function loadAndRenderCO2Charts(userId) {
          const co2NoData = document.getElementById('co2-no-data');
          const humNoData = document.getElementById('hum-no-data');
          const co2Canvas = document.getElementById('co2Chart');
          const humCanvas = document.getElementById('humChart');

          try {
              const resp = await fetch(`http://localhost:8000/api/co2/last-session/${userId}`);
              if (resp.status === 404) {
                  co2NoData.style.display = 'block'; co2Canvas.style.display = 'none';
                  humNoData.style.display = 'block'; humCanvas.style.display = 'none';
                  return;
              }
              const session = await resp.json();
              if (!session.senal || session.senal.length === 0) {
                  co2NoData.style.display = 'block'; co2Canvas.style.display = 'none';
                  humNoData.style.display = 'block'; humCanvas.style.display = 'none';
                  return;
              }

              // Data exists
              co2NoData.style.display = 'none'; co2Canvas.style.display = 'block';
              humNoData.style.display = 'none'; humCanvas.style.display = 'block';

              const rawCo2 = session.senal;
              const rawHum = session.humedad;
              const stableCo2 = session.co2_estabilizado || [];
              const stableHum = session.hum_estabilizada || [];

              // Helper to find closest index in raw array for a target value
              function findClosestIndex(arr, target) {
                  let bestIdx = 0;
                  let bestDiff = Infinity;
                  for (let i = 0; i < arr.length; i++) {
                      const diff = Math.abs(arr[i] - target);
                      if (diff < bestDiff) {
                          bestDiff = diff;
                          bestIdx = i;
                      }
                  }
                  return bestIdx;
              }

              // Linear Regression Helper
              function linearRegression(points) {
                  const n = points.length;
                  if (n === 0) return null;
                  let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
                  points.forEach(p => {
                      const x = p.x;
                      const y = p.y;
                      sumX += x;
                      sumY += y;
                      sumXY += x * y;
                      sumXX += x * x;
                  });
                  const denominator = (n * sumXX - sumX * sumX);
                  if (denominator === 0) return null;
                  const m = (n * sumXY - sumX * sumY) / denominator;
                  const b = (sumY - m * sumX) / n;
                  return { m, b };
              }

              // --- PREPARE DATA ---

              // CO2 Data Series
              const co2RawSeries = rawCo2.map((val, i) => ({ x: i + 1, y: val }));
              let co2StableSeries = stableCo2.map(val => {
                  const idx = findClosestIndex(rawCo2, val);
                  return { x: idx + 1, y: val };
              });
              co2StableSeries.sort((a, b) => a.x - b.x); // Sort by index

              // CO2 Regression
              const lrCo2 = linearRegression(co2StableSeries);
              let co2RegressionSeries = [];
              if (lrCo2 && co2StableSeries.length > 0) {
                  const xMin = co2StableSeries[0].x;
                  const xMax = co2StableSeries[co2StableSeries.length - 1].x;
                  co2RegressionSeries = [
                      { x: xMin, y: lrCo2.m * xMin + lrCo2.b },
                      { x: xMax, y: lrCo2.m * xMax + lrCo2.b }
                  ];
              }

              // Hum Data Series
              const humRawSeries = rawHum.map((val, i) => ({ x: i + 1, y: val }));
              let humStableSeries = stableHum.map(val => {
                  const idx = findClosestIndex(rawHum, val);
                  return { x: idx + 1, y: val };
              });
              humStableSeries.sort((a, b) => a.x - b.x);

              // Hum Regression
              const lrHum = linearRegression(humStableSeries);
              let humRegressionSeries = [];
              if (lrHum && humStableSeries.length > 0) {
                  const xMin = humStableSeries[0].x;
                  const xMax = humStableSeries[humStableSeries.length - 1].x;
                  humRegressionSeries = [
                      { x: xMin, y: lrHum.m * xMin + lrHum.b },
                      { x: xMax, y: lrHum.m * xMax + lrHum.b }
                  ];
              }

              // Y-Axis Range for CO2
              const maxCo2Val = Math.max(...rawCo2);
              const co2Margin = maxCo2Val * 0.1;
              const co2MaxAxis = Math.ceil(maxCo2Val + co2Margin);

              // --- CO2 CHART ---
              const ctxCo2 = co2Canvas.getContext('2d');
              if (co2Chart) co2Chart.destroy();
              
              co2Chart = new Chart(ctxCo2, {
                  type: 'line',
                  data: {
                      datasets: [
                          {
                              label: 'CO₂ Raw (ppm)',
                              data: co2RawSeries,
                              borderColor: 'rgba(66,133,244,0.7)',
                              backgroundColor: 'rgba(66,133,244,0.05)',
                              borderWidth: 2,
                              pointRadius: 0,
                              fill: false,
                              tension: 0.1,
                              order: 3
                          },
                          {
                              label: 'Puntos Estabilizados',
                              data: co2StableSeries,
                              type: 'scatter', 
                              backgroundColor: '#FF5722',
                              borderColor: '#FF5722',
                              pointRadius: 6,
                              pointHoverRadius: 8,
                              pointStyle: 'circle',
                              order: 1
                          },
                          {
                              label: 'Regresión Lineal',
                              data: co2RegressionSeries,
                              type: 'line',
                              borderColor: '#FF5722',
                              borderWidth: 2,
                              borderDash: [5, 5],
                              pointRadius: 0,
                              fill: false,
                              tension: 0,
                              order: 2
                          }
                      ]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      interaction: {
                          mode: 'index',
                          intersect: false,
                      },
                      scales: {
                          x: { 
                              type: 'linear',
                              title: {display:true, text:'Muestras'}, 
                              ticks: { stepSize: 10 }
                          },
                          y: { 
                              title: {display:true, text:'ppm'},
                              min: 0,
                              max: co2MaxAxis,
                              ticks: {
                                  callback: function(val) { return val.toFixed(2) + ' ppm'; }
                              }
                          }
                      },
                      plugins: {
                          tooltip: {
                              callbacks: {
                                  title: function(items) {
                                      if (items.length > 0) {
                                          return 'Muestra ' + items[0].parsed.x;
                                      }
                                      return '';
                                  },
                                  label: function(context) {
                                      let label = context.dataset.label || '';
                                      if (label) label += ': ';
                                      if (context.parsed.y !== null) {
                                          label += Number(context.parsed.y).toFixed(2);
                                      }
                                      return label;
                                  }
                              }
                          }
                      }
                  }
              });

              // --- HUM CHART ---
              const ctxHum = humCanvas.getContext('2d');
              if (humChart) humChart.destroy();
              
              humChart = new Chart(ctxHum, {
                  type: 'line',
                  data: {
                      datasets: [
                          {
                              label: 'Humedad Raw (%)',
                              data: humRawSeries,
                              borderColor: 'rgba(54, 162, 235, 0.7)',
                              backgroundColor: 'rgba(54, 162, 235, 0.05)',
                              borderWidth: 2,
                              pointRadius: 0,
                              fill: false,
                              tension: 0.1,
                              order: 3
                          },
                          {
                              label: 'Puntos Estabilizados',
                              data: humStableSeries,
                              type: 'scatter',
                              backgroundColor: '#E91E63',
                              borderColor: '#E91E63',
                              pointRadius: 6,
                              pointHoverRadius: 8,
                              pointStyle: 'circle',
                              order: 1
                          },
                          {
                              label: 'Regresión Lineal',
                              data: humRegressionSeries,
                              type: 'line',
                              borderColor: '#E91E63',
                              borderWidth: 2,
                              borderDash: [5, 5],
                              pointRadius: 0,
                              fill: false,
                              tension: 0,
                              order: 2
                          }
                      ]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      interaction: {
                          mode: 'index',
                          intersect: false,
                      },
                      scales: {
                          x: { 
                              type: 'linear',
                              title: {display:true, text:'Muestras'},
                              ticks: { stepSize: 10 }
                          },
                          y: { 
                              title: {display:true, text:'%'},
                              min: 0,
                              max: 100,
                              ticks: {
                                  callback: function(val) { return val.toFixed(2) + ' %'; }
                              }
                          }
                      },
                      plugins: {
                          tooltip: {
                              callbacks: {
                                  title: function(items) {
                                      if (items.length > 0) {
                                          return 'Muestra ' + items[0].parsed.x;
                                      }
                                      return '';
                                  },
                                  label: function(context) {
                                      let label = context.dataset.label || '';
                                      if (label) label += ': ';
                                      if (context.parsed.y !== null) {
                                          label += Number(context.parsed.y).toFixed(2);
                                      }
                                      return label;
                                  }
                              }
                          }
                      }
                  }
              });

          } catch (e) {
              console.error("Error loading CO2 charts:", e);
              co2NoData.style.display = 'block'; co2Canvas.style.display = 'none';
              humNoData.style.display = 'block'; humCanvas.style.display = 'none';
          }
      }

      // -------------- NUEVO CÓDIGO ECG ----------------
      let ecgChart = null;

      async function loadAndRenderECG(userId) {
        const noDataMsg = document.getElementById('ecg-no-data');
        const canvas = document.getElementById('ecgChart');

        try {
          const resp = await fetch(`http://localhost:8000/api/ecg/latest/${userId}`);
          
          if (resp.status === 404) {
             noDataMsg.style.display = 'block';
             canvas.style.display = 'none';
             return;
          }
          
          if (!resp.ok) return; 

          const data = await resp.json();
          const signal = data.signal || [];
          const fs = data.fs || 200;
          
          if (signal.length === 0) {
             noDataMsg.style.display = 'block';
             canvas.style.display = 'none';
             return;
          }

          noDataMsg.style.display = 'none';
          canvas.style.display = 'block';

          const dt = 1.0 / fs;
          const labels = signal.map((_, i) => (i * dt).toFixed(2));

          if (!ecgChart) {
             const ctx = canvas.getContext('2d');
             ecgChart = new Chart(ctx, {
                type: 'line',
                data: {
                  labels: labels,
                  datasets: [{
                    label: 'Amplitud (mV)',
                    data: signal,
                    borderColor: 'rgb(235, 77, 75)', 
                    backgroundColor: 'rgba(235, 77, 75, 0.05)',
                    borderWidth: 2,
                    pointRadius: 0, 
                    tension: 0.1,   
                    fill: false
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  animation: false,
                  scales: {
                    x: {
                      title: { display: true, text: 'Tiempo (s)', color: '#556' },
                      ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 10 },
                      grid: { display:false }
                    },
                    y: {
                      title: { display: true, text: 'mV', color: '#556' },
                      grid: { color: 'rgba(0,0,0,0.05)' }
                    }
                  },
                  plugins: {
                    legend: { display: false },
                    tooltip: { 
                      enabled: true,
                      mode: 'nearest', 
                      intersect: false,
                      callbacks: {
                        label: function(ctx) {
                           return ctx.raw + ' mV';
                        }
                      }
                    }
                  },
                  elements: { line: { borderJoinStyle: 'round' } },
                  interaction: { mode: 'nearest', intersect: false }
                }
             });
          } else {
             ecgChart.data.labels = labels;
             ecgChart.data.datasets[0].data = signal;
             ecgChart.update();
          }

        } catch (e) {
          console.error("Error loading ECG:", e);
        }
      }

      obtenerValoresActuales().then(valores => {
        actualizarMetricas(valores);
        loadAndRenderCO2Charts(userId);
        loadAndRenderECG(userId);
      });


      document.getElementById('manualForm').onsubmit = async function(e) {
        e.preventDefault();
        const valoresActuales = await obtenerValoresActuales();


        const spo2 = parseFloat(document.getElementById('spo2-input').value);
        const cintura = parseFloat(document.getElementById('cintura-input').value);
        const peso = valoresActuales.peso || 70;
        const grasa_porc = parseFloat(((0.23 * cintura) + (0.23 * peso) - 5.4).toFixed(2));
        
        const now = new Date().toISOString();

        const nuevosValores = {
          ...valoresActuales,
          spo2: spo2,
          grasa_porc: grasa_porc,
        };
        
        console.log('POST VALORES:', nuevosValores);

        await fetch('http://localhost:8000/api/mediciones', {
          method: 'POST',
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            idUsuario: userId,
            valores: nuevosValores,
            fecha: now,
            quien_realizo: userId
          })
        });

        actualizarMetricas(nuevosValores);
        // Reload charts just in case, though manual update doesn't change CO2
        loadAndRenderCO2Charts(userId);
        loadAndRenderECG(userId);

        document.getElementById('msg-box').innerHTML = `<div class="success-message" style="color:#20bb4f;font-weight:700;text-align:center;margin-bottom:1.3em;">Datos guardados correctamente</div>`;
      };
    });
  </script>
</body>
</html>
