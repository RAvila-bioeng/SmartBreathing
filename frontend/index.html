<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartBreathing - Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
  <link href="https://fonts.googleapis.com/css?family=Poppins:400,600,800&display=swap" rel="stylesheet">
  
  <!-- Shared Styles -->
  <link rel="stylesheet" href="css/nav.css">
  <link rel="stylesheet" href="css/styles.css">

  <style>
    /* Fondo animado suave, en línea con el resto */
    body {
        background: var(--bg-gradient-light);
        background-size: 200% 200%;
        animation: subtleGradient 18s ease-in-out infinite;
        font-family: 'Poppins', sans-serif;
    }

    .dashboard-container { 
        max-width: 1120px; 
        margin: 40px auto; 
        background: var(--card-bg); 
        border-radius: var(--radius-lg); 
        box-shadow: var(--shadow-soft); 
        padding: 40px; 
        min-height: 90vh; 
        backdrop-filter: blur(10px);
        transition: box-shadow 0.25s ease, transform 0.25s ease;
    }

    .dashboard-container:hover {
        box-shadow: 0 18px 44px rgba(0, 0, 0, 0.12);
        transform: translateY(-4px);
    }
    
    .header { 
        text-align: center; 
        margin-bottom: 24px; 
    }

    .header-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin: 0 auto 10px auto;
        background: var(--primary-gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        box-shadow: 0 12px 26px rgba(102,126,234,0.4);
    }

    .header-icon i { font-size: 1.6rem; }

    .header h1 { 
        color: #6066dc; 
        font-weight: 900; 
        font-size: 2.1em; 
        margin-bottom: 5px; 
        margin-top: 5px; 
        letter-spacing: .01em; 
    }

    .header p { 
        color: #474b6a; 
        font-weight: 600; 
        letter-spacing: .01em; 
        margin-bottom: 8px; 
        margin-top: 0; 
        font-size: 1.05em; 
    }
    
    .manual-form { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 15px; 
        justify-content: center; 
        align-items: center; 
        margin-bottom: 38px; 
        margin-top: 20px; 
        font-size: 1.02em; 
        background: #f9fafe; 
        padding: 25px; 
        border-radius: var(--radius-md); 
        box-shadow: 0 2px 15px rgba(0,0,0,0.03);
    }

    .manual-form label { 
        font-weight: 700; 
        letter-spacing: .01em; 
        color: #434894; 
        margin:0 4px 0 0; 
    }

    .manual-form input[type="number"] { 
        padding: 10px; 
        font-size: 1em; 
        border-radius: 10px; 
        border: 1px solid #bbc6f8; 
        outline: none; 
        max-width: 80px; 
        min-width:60px; 
        text-align:right; 
        background: #fff; 
        margin-right:14px;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
    }

    .manual-form input[type="number"]:hover {
        border-color: #8fa2ff;
        box-shadow: 0 4px 10px rgba(143,162,255,0.25);
        transform: translateY(-1px);
    }

    .manual-form .co2-row, .manual-form .hum-row { 
        display: flex; 
        flex-wrap: wrap; 
        align-items: center; 
        gap:8px; 
        width:100%; 
        justify-content: center;
        margin-top:15px;
    }

    .manual-form button { 
        padding: 12px 22px; 
        font-size: 1em; 
        border-radius: 14px; 
        border: none; 
        font-weight: bold; 
        color: white; 
        background: var(--primary-gradient); 
        cursor: pointer; 
        margin-left:10px; 
        transition: all 0.2s;
    }

    .manual-form button:hover { 
        transform: translateY(-2px); 
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); 
        filter: brightness(1.05);
    }
    
    .metrics-grid { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 24px; 
        justify-content: center; 
        margin: 25px 0 28px 0; 
    }

    .metric-card { 
        background: #f9fafe; 
        border-radius: 21px; 
        min-width: 211px; 
        min-height: 120px; 
        padding: 15px 20px 17px 20px; 
        box-shadow: 0 4px 16px rgba(0,0,0,0.04); 
        text-align: center; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        position: relative; 
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    .metric-card:hover { 
        transform: translateY(-4px); 
        box-shadow: 0 10px 26px rgba(0,0,0,0.08); 
        background:#ffffff;
    }

    .metric-title { 
        font-size: 1.02em; 
        font-weight: 800; 
        color: #554ab8; 
        margin-bottom: 4px; 
        letter-spacing: .02em; 
    }

    .metric-title i {
        margin-right: 6px;
    }

    .metric-value { 
        font-size: 2.05em; 
        font-weight: bold; 
        margin: 5px 0 2px 0; 
        color:#293265; 
    }

    .metric-unit { 
        position: absolute; 
        right: 13px; 
        top: 9px; 
        color: #8797e8; 
        font-size: 1.01em; 
        font-weight: 800; 
    }
    
    .status-indicator { 
        display: inline-block; 
        width: 18px; 
        height: 18px; 
        border-radius: 100%; 
        margin-right: 7px; 
        vertical-align: middle; 
        border: 2px solid #bfc9ec;
    }

    .status-good {background: #7af77a; border-color: #48e248;}
    .status-warning {background: #FFEA6C; border-color:#f7ca33;}
    .status-danger {background: #f77070; border-color: #e94c4c;}
    
    .co2-value-box, .hum-value-box { 
        font-size: 1.1em; 
        font-weight:700;  
        background: #ecf1ff; 
        border-radius:9px; 
        box-shadow:0 1.5px 7px #9bb0e42a;
        margin:0 3px; 
        min-width:60px; 
        padding:7px 11px; 
        color:#444aaf;
        transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
        text-align:center;
    }

    .co2-value-box:hover, .hum-value-box:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(123,139,238,0.35);
        background:#dde5ff;
    }

    .chart-container { 
        background: #fff; 
        border-radius: 17px; 
        box-shadow: 0 6px 28px rgba(0,0,0,0.06); 
        padding: 26px; 
        margin-bottom: 28px; 
        margin-top: 28px; 
        max-width: 1000px; /* ligeramente mayor para más presencia */
        margin-left: auto; 
        margin-right: auto;
        transition: box-shadow 0.25s ease, transform 0.25s ease;
    }

    /* ALTURA MÁS GRANDE E INTERMEDIA DEL CANVAS (CAMBIO SOLICITADO) */
    .chart-container canvas {
      height: 420px !important; /* aumentado para que se vea mejor */
      max-height: 480px;
      width: 100% !important;
    }

    .chart-container:hover {
        box-shadow: 0 18px 42px rgba(0,0,0,0.09);
        transform: translateY(-3px);
    }

    .chart-title {
        font-weight:bold; 
        color:#6066dc; 
        margin-bottom:14px;
        display:flex;
        align-items:center;
        gap:8px;
        font-size:1.05rem;
    }

    .chart-title i {
        font-size:1rem;
    }
    
    @media (max-width: 900px) {
      .chart-container { max-width: 100%; padding: 18px; }
    }
    @media (max-width: 650px) { 
        .metrics-grid {
            flex-direction:column; 
            align-items:center;
        } 
        .dashboard-container {
            padding: 20px;
            margin: 20px auto;
        }
        .manual-form {
            padding: 18px;
        }
        .chart-container {
          max-width: 100%;
        }
    }
  </style>
</head>
<body>
  
  <script src="js/nav.js"></script>

  <div class="dashboard-container">
    <div class="header">
      <div class="header-icon">
        <i class="fas fa-heartbeat"></i>
      </div>
      <h1>SmartBreathing</h1>
      <p>Dashboard de Monitoreo Fisiológico</p>
      <div style="margin-top: 8px; font-size: 1.13em; color: #444aaf; font-weight: 600;" id="welcome-box">
        Bienvenido de nuevo
      </div>
    </div>
    
    <form class="manual-form" id="manualForm" autocomplete="off">
      <label for="spo2-input">SpO₂ (%)</label>
      <input type="number" id="spo2-input" name="spo2" min="50" max="100" step="0.1" required placeholder="%"/>
      <label for="cintura-input">Cintura (cm)</label>
      <input type="number" id="cintura-input" name="cintura" min="20" max="250" step="0.1" required placeholder="cm"/>
      
      <!-- CO2 inputs -->
      <div class="co2-row">
        <label for="co2-1-input">CO₂ 1</label>
        <input type="number" id="co2-1-input" name="co2_1" min="0" max="40000" step="0.1" required placeholder="ppm"/>
        <label for="co2-2-input">CO₂ 2</label>
        <input type="number" id="co2-2-input" name="co2_2" min="0" max="40000" step="0.1" required placeholder="ppm"/>
        <label for="co2-3-input">CO₂ 3</label>
        <input type="number" id="co2-3-input" name="co2_3" min="0" max="40000" step="0.1" required placeholder="ppm"/>
        <label for="co2-4-input">CO₂ 4</label>
        <input type="number" id="co2-4-input" name="co2_4" min="0" max="40000" step="0.1" required placeholder="ppm"/>
        <label for="co2-5-input">CO₂ 5</label>
        <input type="number" id="co2-5-input" name="co2_5" min="0" max="40000" step="0.1" required placeholder="ppm"/>
      </div>

      <!-- HUMEDAD inputs (nuevos) -->
      <div class="hum-row" style="margin-top:8px;">
        <label for="hum-1-input">Humedad 1</label>
        <input type="number" id="hum-1-input" name="hum_1" min="0" max="100" step="0.1" required placeholder="%"/>
        <label for="hum-2-input">Humedad 2</label>
        <input type="number" id="hum-2-input" name="hum_2" min="0" max="100" step="0.1" required placeholder="%"/>
        <label for="hum-3-input">Humedad 3</label>
        <input type="number" id="hum-3-input" name="hum_3" min="0" max="100" step="0.1" required placeholder="%"/>
        <label for="hum-4-input">Humedad 4</label>
        <input type="number" id="hum-4-input" name="hum_4" min="0" max="100" step="0.1" required placeholder="%"/>
        <label for="hum-5-input">Humedad 5</label>
        <input type="number" id="hum-5-input" name="hum_5" min="0" max="100" step="0.1" required placeholder="%"/>
      </div>

      <div style="width:100%; display:flex; justify-content:center; margin-top:12px;">
        <button type="submit">Guardar datos</button>
      </div>
    </form>
    
    <div id="msg-box"></div>
    
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-title"><i class="fas fa-lungs"></i> Saturación de Oxígeno (SpO₂)</div>
        <div class="metric-value" id="spo2-value">--</div>
        <div class="metric-unit">%</div>
        <div class="status-indicator status-good" id="spo2-status"></div>
        <span id="spo2-text">Normal</span>
      </div>

      <!-- CO2 display card (igual que antes) -->
      <div class="metric-card metric-co2-all">
        <div class="metric-title">
          CO₂ (ppm) 
          <span style="color:#869;margin-left:4px; font-size:0.98em;font-weight:400;">
            (últimas lecturas)
          </span>
        </div>
        <div style="display:flex; justify-content:center; gap:10px; margin-top:10px; flex-wrap:wrap;">
          <div><div class="co2-value-box" id="co2-1-value">--</div></div>
          <div><div class="co2-value-box" id="co2-2-value">--</div></div>
          <div><div class="co2-value-box" id="co2-3-value">--</div></div>
          <div><div class="co2-value-box" id="co2-4-value">--</div></div>
          <div><div class="co2-value-box" id="co2-5-value">--</div></div>
        </div>
      </div>

      <!-- NUEVA tarjeta para HUMEDAD -->
      <div class="metric-card metric-hum-all">
        <div class="metric-title">
          Humedad (%) 
          <span style="color:#869;margin-left:4px; font-size:0.98em;font-weight:400;">
            (últimas lecturas)
          </span>
        </div>
        <div style="display:flex; justify-content:center; gap:10px; margin-top:10px; flex-wrap:wrap;">
          <div><div class="hum-value-box" id="hum-1-value">--</div></div>
          <div><div class="hum-value-box" id="hum-2-value">--</div></div>
          <div><div class="hum-value-box" id="hum-3-value">--</div></div>
          <div><div class="hum-value-box" id="hum-4-value">--</div></div>
          <div><div class="hum-value-box" id="hum-5-value">--</div></div>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-title"><i class="fas fa-heart"></i> Frecuencia Cardíaca (bpm)</div>
        <div class="metric-value" id="hr-value">--</div>
        <div class="status-indicator status-good" id="hr-status"></div>
        <span id="hr-text">Normal</span>
      </div>
      <div class="metric-card">
        <div class="metric-title"><i class="fas fa-user-md"></i> % Grasa Corporal (YMCA)</div>
        <div class="metric-value" id="grasa-value">--</div>
        <div class="status-indicator status-good" id="grasa-status"></div>
        <span id="grasa-text">---</span>
      </div>
    </div>
    
    <div class="chart-container">
      <div class="chart-title">
        <i class="fas fa-chart-line"></i> Tendencias en Tiempo Real
      </div>
      <canvas id="trendsChart" width="1000" height="420"></canvas>
    </div>
    
    <div style="text-align:center;margin:2em 0 0.4em 0;color:#4162ea;font-size:1.05em;font-weight:600;">
      Gestor de rutinas y recomendaciones disponible a través del Bot de Telegram.
    </div>
  </div>
  
  <script>
    /* JS ORIGINAL – NO TOCADO (salvo dataset de humedad y eje secundario) */
    document.addEventListener("DOMContentLoaded", async function() {
      const userId = localStorage.getItem('user_id');
      const userName = localStorage.getItem('user_name');
      if (!userId) {
        window.location.href = "login.html";
        return;
      }
      document.getElementById('welcome-box').textContent = `Bienvenido de nuevo${userName ? ", " + userName : ""}`;

      // Notify backend that this user is the "current ECG user"
      try {
        await fetch('http://localhost:8000/api/ecg/current-user', {
          method: 'POST',
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: userId })
        });
        console.log("Notified backend of current ECG user:", userId);
      } catch (e) {
        console.warn("Failed to notify backend of current ECG user:", e);
      }

      let userAge = null, userGender = null;
      try {
        const resp = await fetch(`http://localhost:8000/api/users/by_id/${userId}`);
        if (resp.ok) {
          const userData = await resp.json();
          userAge = Number(userData.edad) || null;
          userGender = (userData.genero || userData.genero_usuario || '').toLowerCase();
        }
      } catch(e) {}


      async function obtenerValoresActuales() {
        try {
          const response = await fetch('http://localhost:8000/api/mediciones?user_id=' + encodeURIComponent(userId));
          if (!response.ok) throw new Error("Error al cargar datos");
          const mediciones = await response.json();
          if (mediciones.length > 0 && mediciones[0].valores) {
            return mediciones[0].valores;
          }
        } catch (e) {}
        return {};
      }


      function spo2ColorEstado(valor) {
        if (valor >= 95) return { estado: 'Normal', color: 'status-good' };
        if (valor >= 90) return { estado: 'Precaución', color: 'status-warning' };
        return { estado: 'Grave', color: 'status-danger' };
      }


      function rangoGrasaYColor(grasa, sexo, edad) {
        let normalMin, normalMax, warningMax;
        if (sexo === 'mujer') {
          if (edad >= 20 && edad < 40)      { normalMin = 21; normalMax = 33; warningMax = 39; }
          else if (edad >= 40 && edad <= 59){ normalMin = 23; normalMax = 34; warningMax = 40; }
          else                              { normalMin = 23; normalMax = 35; warningMax = 40; }
        } else if (sexo === 'hombre') {
          if (edad >= 20 && edad < 40)      { normalMin = 8;  normalMax = 20; warningMax = 25; }
          else if (edad >= 40 && edad <= 59){ normalMin = 11; normalMax = 22; warningMax = 28; }
          else                              { normalMin = 11; normalMax = 22; warningMax = 28; }
        } else { return { nivel: '---', color: 'status-warning' }; }


        if(grasa < normalMin) return { nivel: 'Precaución', color: 'status-warning' };
        if(grasa <= normalMax) return { nivel: 'Normal', color: 'status-good' };
        if(grasa <= warningMax) return { nivel: 'Moderado', color: 'status-warning' };
        return { nivel: 'Grave', color: 'status-danger' };
      }


      function actualizarMetricas(valores) {
        // SpO₂
        const spo2Val = valores.spo2 !== undefined ? Number(valores.spo2).toFixed(1) : '--';
        document.getElementById('spo2-value').textContent = spo2Val;
        const spo2Est = spo2ColorEstado(Number(valores.spo2));
        ['status-good','status-warning','status-danger'].forEach(c => document.getElementById('spo2-status').classList.remove(c));
        document.getElementById('spo2-status').classList.add(spo2Est.color);
        document.getElementById('spo2-text').textContent = spo2Est.estado;


        // % Grasa (YMCA)
        const grasaVal = valores.grasa_porc !== undefined ? Number(valores.grasa_porc).toFixed(2) : '--';
        document.getElementById('grasa-value').textContent = grasaVal;
        const grasaEst = (valores.grasa_porc !== undefined && userGender && userAge)
          ? rangoGrasaYColor(Number(valores.grasa_porc), userGender, userAge)
          : {nivel: '---', color: 'status-warning'};
        ['status-good','status-warning','status-danger'].forEach(c => document.getElementById('grasa-status').classList.remove(c));
        document.getElementById('grasa-status').classList.add(grasaEst.color);
        document.getElementById('grasa-text').textContent = grasaEst.nivel;


        // CO₂ valores en línea
        document.getElementById('co2-1-value').textContent = valores.co2_1 !== undefined ? valores.co2_1 : '--';
        document.getElementById('co2-2-value').textContent = valores.co2_2 !== undefined ? valores.co2_2 : '--';
        document.getElementById('co2-3-value').textContent = valores.co2_3 !== undefined ? valores.co2_3 : '--';
        document.getElementById('co2-4-value').textContent = valores.co2_4 !== undefined ? valores.co2_4 : '--';
        document.getElementById('co2-5-value').textContent = valores.co2_5 !== undefined ? valores.co2_5 : '--';

        // HUMEDAD valores en línea (nuevos)
        document.getElementById('hum-1-value').textContent = valores.hum_1 !== undefined ? valores.hum_1 + ' %' : '--';
        document.getElementById('hum-2-value').textContent = valores.hum_2 !== undefined ? valores.hum_2 + ' %' : '--';
        document.getElementById('hum-3-value').textContent = valores.hum_3 !== undefined ? valores.hum_3 + ' %' : '--';
        document.getElementById('hum-4-value').textContent = valores.hum_4 !== undefined ? valores.hum_4 + ' %' : '--';
        document.getElementById('hum-5-value').textContent = valores.hum_5 !== undefined ? valores.hum_5 + ' %' : '--';
      }


      // -------------- CÓDIGO AÑADIDO: GRÁFICA DOBLE EJE (CO2 + HUMEDAD) ----------------
      let trendsChart = null;

      function extractCo2Array(valores) {
        return [
          valores.co2_1 !== undefined && valores.co2_1 !== null && valores.co2_1 !== '' ? Number(valores.co2_1) : null,
          valores.co2_2 !== undefined && valores.co2_2 !== null && valores.co2_2 !== '' ? Number(valores.co2_2) : null,
          valores.co2_3 !== undefined && valores.co2_3 !== null && valores.co2_3 !== '' ? Number(valores.co2_3) : null,
          valores.co2_4 !== undefined && valores.co2_4 !== null && valores.co2_4 !== '' ? Number(valores.co2_4) : null,
          valores.co2_5 !== undefined && valores.co2_5 !== null && valores.co2_5 !== '' ? Number(valores.co2_5) : null
        ];
      }

      function extractHumArray(valores) {
        return [
          valores.hum_1 !== undefined && valores.hum_1 !== null && valores.hum_1 !== '' ? Number(valores.hum_1) : null,
          valores.hum_2 !== undefined && valores.hum_2 !== null && valores.hum_2 !== '' ? Number(valores.hum_2) : null,
          valores.hum_3 !== undefined && valores.hum_3 !== null && valores.hum_3 !== '' ? Number(valores.hum_3) : null,
          valores.hum_4 !== undefined && valores.hum_4 !== null && valores.hum_4 !== '' ? Number(valores.hum_4) : null,
          valores.hum_5 !== undefined && valores.hum_5 !== null && valores.hum_5 !== '' ? Number(valores.hum_5) : null
        ];
      }

      // calcula yMax y stepSize manteniendo máximo por defecto en 40.000 ppm
      function computeYAxisParams(dataArr) {
        const numeric = dataArr.filter(v => v !== null && !isNaN(v));
        const CAP = 40000;
        if (numeric.length === 0) {
          return { yMax: CAP, step: 5000 };
        }
        const maxVal = Math.max(...numeric);
        // Si los datos entran en el rango <= CAP, fijamos yMax = CAP y step a 5000
        if (maxVal <= CAP) {
          return { yMax: CAP, step: 5000 };
        }
        // Si alguna medida supera CAP, calculamos un yMax mayor que cubra ese valor con pasos grandes
        const approxSteps = 5;
        let rawStep = Math.ceil(maxVal / approxSteps);
        let step = 100;
        if (rawStep > 5000) step = 1000;
        else if (rawStep > 2500) step = 500;
        else if (rawStep > 800) step = 250;
        else if (rawStep > 300) step = 200;
        else step = 100;
        const yMax = Math.ceil(maxVal / step) * step;
        return { yMax: Math.max(yMax, step), step };
      }

      function updateChartWithValues(valores) {
        const co2arr = extractCo2Array(valores);
        const humarr = extractHumArray(valores);
        const labels = ['1','2','3','4','5'];

        const yParams = computeYAxisParams(co2arr);

        if (!trendsChart) {
          const ctx = document.getElementById('trendsChart').getContext('2d');
          trendsChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [
                {
                  label: 'CO₂ (ppm)',
                  data: co2arr,
                  yAxisID: 'yCo2',
                  fill: false,                 // <-- sin sombreado bajo la curva
                  tension: 0.28,
                  pointRadius: 7,              // círculos azules grandes
                  pointHoverRadius: 9,
                  borderWidth: 3,
                  backgroundColor: 'rgba(66,133,244,0.0)', // transparente
                  borderColor: 'rgba(66,133,244,0.95)',
                  pointBackgroundColor: '#ffffff',
                  pointBorderColor: 'rgba(66,133,244,0.95)',
                  pointStyle: 'circle',
                  spanGaps: true
                },
                {
                  label: 'Humedad (%)',
                  data: humarr,
                  yAxisID: 'yHum',
                  fill: false,
                  tension: 0.2,
                  pointRadius: 7,              // cuadrados del mismo tamaño que los círculos
                  pointHoverRadius: 9,
                  borderWidth: 2.6,
                  backgroundColor: 'rgba(255,99,132,0.0)', // transparente
                  borderColor: 'rgba(255,99,132,0.95)',
                  pointBackgroundColor: 'rgba(255,99,132,0.95)',
                  pointBorderColor: '#ffffff',
                  pointStyle: 'rect',          // cuadrado
                  spanGaps: true
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              layout: { padding: { top: 6, bottom: 6, left: 6, right: 6 } },
              scales: {
                x: {
                  title: { display: true, text: 'Número de medición', color: '#556' },
                  ticks: { maxRotation: 0, autoSkip: false, font: { size: 13, family: 'Poppins, sans-serif' } },
                  grid: { color: 'rgba(0,0,0,0.03)' }
                },
                yCo2: {
                  type: 'linear',
                  position: 'left',
                  title: { display: true, text: 'CO₂ (ppm)', color: '#556' },
                  beginAtZero: true,
                  min: 0,
                  max: yParams.yMax,
                  ticks: {
                    stepSize: yParams.step,
                    callback: function(value) { return value + ' ppm'; },
                    font: { size: 12, family: 'Poppins, sans-serif' }
                  },
                  grid: {
                    color: 'rgba(0,0,0,0.06)',
                    borderDash: [2, 4]
                  }
                },
                yHum: {
                  type: 'linear',
                  position: 'right',
                  title: { display: true, text: 'Humedad (%)', color: '#556' }, // <-- en negro (mismo color que CO2)
                  beginAtZero: true,
                  min: 0,
                  max: 100,
                  ticks: {
                    stepSize: 20,
                    callback: function(value) { return value + ' %'; },
                    font: { size: 12, family: 'Poppins, sans-serif' }
                  },
                  grid: { display: false } // evita grid por duplicado
                }
              },
              plugins: {
                legend: {
                  display: true,
                  labels: {
                    usePointStyle: true,
                    boxWidth: 10,
                    font: { family: 'Poppins, sans-serif', size: 12 }
                  }
                },
                tooltip: {
                  enabled: true,
                  backgroundColor: 'rgba(0,0,0,0.82)',
                  titleFont: { family: 'Poppins, sans-serif', size: 13 },
                  bodyFont: { family: 'Poppins, sans-serif', size: 13 },
                  callbacks: {
                    label: function(context) {
                      const seriesLabel = context.dataset.label || '';
                      const val = context.raw;
                      if (seriesLabel.includes('CO₂')) return `CO₂: ${val !== null ? val : '—'} ppm`;
                      if (seriesLabel.includes('Humedad')) return `Humedad: ${val !== null ? val : '—'} %`;
                      return `${seriesLabel}: ${val}`;
                    }
                  }
                }
              },
              elements: { line: { borderJoinStyle: 'round' } },
              interaction: { mode: 'nearest', intersect: false }
            }
          });

          // height for canvas
          document.getElementById('trendsChart').style.height = '420px';
        } else {
          // actualizamos datos y escalas según valores nuevos
          trendsChart.data.datasets[0].data = co2arr;
          trendsChart.data.datasets[1].data = humarr;
          trendsChart.options.scales.yCo2.max = yParams.yMax;
          trendsChart.options.scales.yCo2.ticks.stepSize = yParams.step;
          // yHum (0-100) queda fijo
          trendsChart.update();
        }
      }
      // -------------- FIN CÓDIGO GRÁFICA ----------------


      obtenerValoresActuales().then(valores => {
        actualizarMetricas(valores);
        updateChartWithValues(valores);
      });


      document.getElementById('manualForm').onsubmit = async function(e) {
        e.preventDefault();
        const valoresActuales = await obtenerValoresActuales();


        const spo2 = parseFloat(document.getElementById('spo2-input').value);
        const cintura = parseFloat(document.getElementById('cintura-input').value);
        const peso = valoresActuales.peso || 70;
        const grasa_porc = parseFloat(((0.23 * cintura) + (0.23 * peso) - 5.4).toFixed(2));
        const co2_1 = parseFloat(document.getElementById('co2-1-input').value);
        const co2_2 = parseFloat(document.getElementById('co2-2-input').value);
        const co2_3 = parseFloat(document.getElementById('co2-3-input').value);
        const co2_4 = parseFloat(document.getElementById('co2-4-input').value);
        const co2_5 = parseFloat(document.getElementById('co2-5-input').value);

        // Nuevos: humedades
        const hum_1 = parseFloat(document.getElementById('hum-1-input').value);
        const hum_2 = parseFloat(document.getElementById('hum-2-input').value);
        const hum_3 = parseFloat(document.getElementById('hum-3-input').value);
        const hum_4 = parseFloat(document.getElementById('hum-4-input').value);
        const hum_5 = parseFloat(document.getElementById('hum-5-input').value);

        const now = new Date().toISOString();


        const nuevosValores = {
          ...valoresActuales,
          spo2: spo2,
          grasa_porc: grasa_porc,
          co2_1: co2_1,
          co2_2: co2_2,
          co2_3: co2_3,
          co2_4: co2_4,
          co2_5: co2_5,
          // añadimos humedad
          hum_1: hum_1,
          hum_2: hum_2,
          hum_3: hum_3,
          hum_4: hum_4,
          hum_5: hum_5
        };


        console.log('POST VALORES:', nuevosValores);


        await fetch('http://localhost:8000/api/mediciones', {
          method: 'POST',
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            idUsuario: userId,
            valores: nuevosValores,
            fecha: now,
            quien_realizo: userId
          })
        });


        actualizarMetricas(nuevosValores);

        // Actualizamos la gráfica con los nuevos valores introducidos (CO2 + Humedad)
        updateChartWithValues(nuevosValores);

        document.getElementById('msg-box').innerHTML = `<div class="success-message" style="color:#20bb4f;font-weight:700;text-align:center;margin-bottom:1.3em;">Datos guardados correctamente</div>`;
      };
    });
  </script>
</body>
</html>











