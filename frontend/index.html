<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartBreathing - Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
  <link href="https://fonts.googleapis.com/css?family=Poppins:400,600,800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: linear-gradient(120deg, #e8eaf6 0%, #d1c4e9 100%); min-height: 100vh; }
    .container { max-width: 1120px; margin: 24px auto 40px auto; background: rgba(255,255,255,0.96); border-radius: 28px; box-shadow: 0 7px 32px rgba(70,82,210,0.11), 0 1px 2px rgba(70,82,210,0.08); padding: 2.3em 2.1em 2.5em 2.1em; min-height: 90vh; }
    .header { text-align: center; margin-bottom: 24px; }
    .header h1 { color: #6066dc; font-weight: 900; font-size: 2.16em; margin-bottom: 5px; margin-top: 5px; letter-spacing: .01em; }
    .header p { color: #474b6a; font-weight: 600; letter-spacing: .01em; margin-bottom: 8px; margin-top: 0; font-size: 1.19em; }
    .manual-form { display: flex; flex-wrap: wrap; gap: 18px; justify-content: center; align-items: center; margin-bottom: 38px; margin-top: 20px; font-size: 1.09em; background: #f9fafe; padding: 18px 26px 16px 26px; border-radius: 17px; box-shadow: 0 2px 15px #e5e7fe11;}
    .manual-form label { font-weight: 700; letter-spacing: .01em; margin-right: 7px; color: #434894; }
    .manual-form input[type="number"] { padding: 7px 14px; font-size: 1.13em; border-radius: 10px; border: 1.2px solid #bbc6f8; outline: none; max-width: 95px; text-align: right; background: #f5f6fa; }
    .manual-form button { padding: 12px 22px; font-size: 1.18em; border-radius: 14px; border: none; font-weight: bold; color: white; background: linear-gradient(92deg, #7a5ff7 20%, #7687f8 100%); cursor: pointer; }
    .manual-form button:hover { background: linear-gradient(102deg, #764ba2 0%, #667eea 100%);}
    .success-message { color:#20bb4f; font-weight:700; text-align:center; margin-bottom:1.3em; font-size:1.16em; }
    .error-message { color:#f44336; font-weight:700; text-align:center; margin-bottom:1.3em; }
    .metrics-grid { display: flex; flex-wrap: wrap; gap: 24px; justify-content: center; margin: 25px 0 28px 0; }
    .metric-card { background: #f9fafe; border-radius: 21px; min-width: 211px; min-height: 120px; padding: 15px 20px 17px 20px; box-shadow: 0 1px 16px #8896ee16; text-align: center; margin-bottom: 5px; display: flex; flex-direction: column; align-items: center; position: relative; }
    .metric-title { font-size: 1.08em; font-weight: 800; color: #554ab8; margin-bottom: 4px; letter-spacing: .02em; }
    .metric-value { font-size: 2.05em; font-weight: bold; margin: 5px 0 2px 0; color:#293265; }
    .metric-unit { position: absolute; right: 13px; top: 9px; color: #8797e8; font-size: 1.01em; font-weight: 800; }
    .status-indicator { display: inline-block; width: 18px; height: 18px; border-radius: 100%; margin-right: 7px; vertical-align: middle; border: 2px solid #bfc9ec;}
    .status-good {background: #7af77a; border-color: #48e248;}
    .status-warning {background: #FFEA6C; border-color:#f7ca33;}
    .status-danger {background: #f77070; border-color: #e94c4c;}
    .chart-container { background: #fff; border-radius: 17px; box-shadow: 0 1px 13px #bbbcea10; padding: 19px 22px; margin-bottom: 28px; margin-top: 28px; max-width: 850px; margin-left: auto; margin-right: auto;}
    .chart-title { font-size:1.14em; font-weight: bold; color:#6066dc; letter-spacing:.01em; margin-bottom: 10px; margin-top: 0; display:flex; align-items:center; gap:7px; }
    @media (max-width: 1000px){ .container {max-width:99vw; padding:1.6em 0.5em;} .chart-container {padding:5px 1em;} .metrics-grid {gap: 9px;} .metric-card {min-width:140px; font-size:0.98em;} }
    @media (max-width: 650px) { .metrics-grid {flex-direction:column; align-items:center;} .container {padding:0.4em 0.22em;} }
    .metric-title::after, .metric-card::after, .metric-card:after, .metric-title:after { all: unset !important; content: none !important; display: none !important; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-heartbeat"></i> SmartBreathing</h1>
      <p>Dashboard de Monitoreo Fisiológico</p>
      <div style="margin-top: 8px; font-size: 1.13em; color: #444aaf; font-weight: 600;" id="welcome-box">
        Bienvenido de nuevo
      </div>
    </div>
    <form class="manual-form" id="manualForm" autocomplete="off">
      <label for="spo2-input">SpO₂ (%)</label>
      <input type="number" id="spo2-input" name="spo2" min="50" max="100" step="0.1" required placeholder="%"/>
      <label for="cintura-input">Cintura (cm)</label>
      <input type="number" id="cintura-input" name="cintura" min="20" max="250" step="0.1" required placeholder="cm"/>
      <button type="submit">Guardar datos</button>
    </form>
    <div id="msg-box"></div>
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-title"><i class="fas fa-lungs"></i> Saturación de Oxígeno (SpO₂)</div>
        <div class="metric-value" id="spo2-value">--</div>
        <div class="metric-unit">%</div>
        <div class="status-indicator status-good" id="spo2-status"></div>
        <span id="spo2-text">Normal</span>
      </div>
      <div class="metric-card">
        <div class="metric-title"><i class="fas fa-cloud"></i> Nivel de CO₂ (ppm)</div>
        <div class="metric-value" id="co2-value">--</div>
        <div class="status-indicator status-good" id="co2-status"></div>
        <span id="co2-text">Normal</span>
      </div>
      <div class="metric-card">
        <div class="metric-title"><i class="fas fa-heart"></i> Frecuencia Cardíaca (bpm)</div>
        <div class="metric-value" id="hr-value">--</div>
        <div class="status-indicator status-good" id="hr-status"></div>
        <span id="hr-text">Normal</span>
      </div>
      <div class="metric-card">
        <div class="metric-title"><i class="fas fa-user-md"></i> % Grasa Corporal (YMCA)</div>
        <div class="metric-value" id="grasa-value">--</div>
        <div class="status-indicator status-good" id="grasa-status"></div>
        <span id="grasa-text">---</span>
      </div>
    </div>
    <div class="chart-container">
      <div class="chart-title"><i class="fas fa-chart-line"></i> Tendencias en Tiempo Real</div>
      <canvas id="trendsChart" width="400" height="200"></canvas>
    </div>
    <div style="text-align:center;margin:2em 0 0.4em 0;color:#4162ea;font-size:1.1em;font-weight:600;">
      Gestor de rutinas y recomendaciones disponible a través del Bot de Telegram.
    </div>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const userId = localStorage.getItem('user_id');
      const userName = localStorage.getItem('user_name');
      if (!userId) {
        window.location.href = "login.html";
        return;
      }
      document.getElementById('welcome-box').textContent = `Bienvenido de nuevo${userName ? ", " + userName : ""}`;

      async function obtenerValoresActuales() {
        try {
          const response = await fetch('http://localhost:8000/api/Mediciones?user_id=' + encodeURIComponent(userId));
          if (!response.ok) throw new Error("Error al cargar datos");
          const mediciones = await response.json();
          if (mediciones.length > 0 && mediciones[0].valores) {
            return mediciones[0].valores;
          }
        } catch (e) {}
        return {};
      }

      document.getElementById('manualForm').onsubmit = async function(e){
        e.preventDefault();

        // SIEMPRE obtener valores actuales justo antes del POST
        const valoresActuales = await obtenerValoresActuales();

        const spo2 = parseFloat(document.getElementById('spo2-input').value);
        const cintura = parseFloat(document.getElementById('cintura-input').value);
        const peso = valoresActuales.peso || 70;
        const grasa_porc = (0.23 * cintura) + (0.23 * peso) - 5.4;
        const now = new Date().toISOString();

        const nuevosValores = { ...valoresActuales, spo2: spo2, grasa_porc: grasa_porc };

        // LOG justo antes del POST
        console.log('POST VALORES:', nuevosValores);

        await fetch('http://localhost:8000/api/Mediciones', {
          method: 'POST',
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            idUsuario: userId,
            valores: nuevosValores,
            fecha: now,
            quien_realizo: userId
          })
        });

        document.getElementById('spo2-value').textContent = spo2.toFixed(1);
        document.getElementById('grasa-value').textContent = grasa_porc.toFixed(1);
        document.getElementById('msg-box').innerHTML = '<div class="success-message">Datos guardados correctamente</div>';
      };
    });
  </script>
</body>
</html>









  
  














