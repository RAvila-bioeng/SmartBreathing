<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>SmartBreathing - Datos del perfil</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
  <link href="https://fonts.googleapis.com/css?family=Poppins:400,600,800&display=swap" rel="stylesheet">
  
  <!-- Shared Styles -->
  <link rel="stylesheet" href="css/nav.css">
  <link rel="stylesheet" href="css/styles.css">
  
  <style>
    /* Fondo animado más vivo para el paso 1 */
    body {
      background: var(--bg-gradient-vivid);
      background-size: 200% 200%;
      animation: gradientMove 12s ease-in-out infinite;
    }
    @keyframes gradientMove {
      0% {background-position: 0% 50%;}
      50% {background-position: 100% 50%;}
      100% {background-position: 0% 50%;}
    }

    .registro-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - var(--nav-height) - 40px);
      padding: 20px;
    }

    .icono-campo { 
      margin-right: 8px; 
      color: #667eea; 
    }

    /* Cabecera del card */
    .perfil-header {
      text-align: center;
      margin-bottom: 18px;
    }

    .perfil-header h1 {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.6em;
      margin-bottom: 6px;
      font-size: 1.8rem;
    }

    .perfil-subtitle {
      margin: 0;
      font-size: 0.95rem;
      color: #878edb;
      opacity: 0.9;
    }

    /* Stepper con un pelín más de punch visual */
    .stepper {
      margin-bottom: 18px;
    }

    .step {
      cursor: default;
    }

    .step.active {
      transform: translateY(-1px);
    }

    /* Labels algo más separados y con icono “alineado” */
    .user-form label {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .user-form input,
    .user-form select {
      margin-top: 4px;
    }

    /* Toast styles específicos */
    .toast {
      visibility: hidden;
      min-width: 220px;
      color: white;
      background: #684CB2;
      text-align: center;
      border-radius: 8px;
      padding: 1.2em 1.4em;
      position: fixed;
      z-index: 2000;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      transition: opacity 0.4s;
      opacity: 0;
      box-shadow: 0 5px 18px rgba(0,0,0,0.25);
      font-size: 0.95rem;
    }
    .toast.show { 
      visibility: visible; 
      opacity: 1; 
    }

    /* Mensaje de error bajo el formulario */
    #mensaje-usuario {
      margin-top: 14px;
      text-align: center;
    }

    /* Placeholder un poco más suave */
    input::placeholder {
      color: #cbd5e0;
    }
  </style>
</head>
<body>

  <!-- Nav script injected -->
  <script src="js/nav.js"></script>

  <div class="registro-wrapper">
    <div class="card-centered" style="margin: 0; max-width: 520px;">
      <div class="stepper">
        <div class="step active">1</div>
        <div class="bar"></div>
        <div class="step">2</div>
      </div>

      <div class="perfil-header">
        <h1>
          <i class="fas fa-id-card-alt icono-campo"></i>
          Datos del perfil
        </h1>
        <p class="perfil-subtitle">
          Completa tu información básica antes de personalizar tu entrenamiento.
        </p>
      </div>

      <form class="user-form" onsubmit="irAPersonalizacion(event)" novalidate>
        <label for="nombre">
          <i class="fas fa-user icono-campo"></i>Nombre
        </label>
        <input type="text" id="nombre" required placeholder="Ej. Juan">
        
        <label for="apellido">
          <i class="fas fa-user icono-campo"></i>Apellido
        </label>
        <input type="text" id="apellido" required placeholder="Ej. Pérez">
        
        <label for="codigo">
          <i class="fas fa-key icono-campo"></i>Código (PIN 4 dígitos)
        </label>
        <!-- STRICT 4-DIGIT PIN INPUT -->
        <input type="text" id="codigo" required maxlength="4" placeholder="0000" inputmode="numeric">
        
        <label for="condiciones">
          <i class="fas fa-diagnoses icono-campo"></i>¿Condiciones limitantes?
        </label>
        <select id="condiciones" required>
          <option value="">Selecciona</option>
          <option value="si">Sí</option>
          <option value="no">No</option>
        </select>
        
        <label for="genero">
          <i class="fas fa-venus-mars icono-campo"></i>Género
        </label>
        <select id="genero" required>
          <option value="">Selecciona</option>
          <option value="hombre">Masculino</option>
          <option value="mujer">Femenino</option>
        </select>
        
        <label for="edad">
          <i class="fas fa-birthday-cake icono-campo"></i>Edad
        </label>
        <input type="number" id="edad" required min="10" max="100">
        
        <label for="peso">
          <i class="fas fa-weight icono-campo"></i>Peso (kg)
        </label>
        <input type="number" step="0.1" id="peso" required min="30" max="300">
        
        <button type="submit" class="btn-primary">
          <i class="fas fa-arrow-right"></i> Siguiente
        </button>
      </form>

      <div class="mensaje error-message" id="mensaje-usuario"></div>
    </div>
  </div>
  
  <div id="toast" class="toast"></div>

  <script>
    function showToast(msg, color="#684CB2") {
      let t = document.getElementById("toast");
      t.textContent = msg;
      t.style.background = color;
      t.className = "toast show";
      setTimeout(() => t.className = "toast", 3000);
    }

    function validaCapital(palabra) {
      const trimmed = palabra.trim();
      if (trimmed.length === 0) return false;
      const primer = trimmed[0];
      return (primer === primer.toUpperCase() && primer !== primer.toLowerCase());
    }

    // --- PIN VALIDATION LOGIC ---
    const codigoInput = document.getElementById('codigo');
    
    // Real-time validation: Allow only numbers
    codigoInput.addEventListener('input', function(e) {
      // Remove any non-digit character
      this.value = this.value.replace(/\D/g, '');
    });

    function irAPersonalizacion(event) {
      event.preventDefault();
      const nombre = document.getElementById('nombre').value.trim();
      const apellido = document.getElementById('apellido').value.trim();
      const codigo = document.getElementById('codigo').value.trim();
      const condiciones = document.getElementById('condiciones').value;
      const genero = document.getElementById('genero').value;
      const edad = document.getElementById('edad').value;
      const peso = document.getElementById('peso').value;

      // Reset messages
      const msgBox = document.getElementById('mensaje-usuario');
      msgBox.textContent = "";

      if (!nombre || !apellido || !codigo || !condiciones || !genero || !edad || !peso) {
        showToast("Por favor, rellena todos los campos.", "#e13333");
        return;
      }

      // PIN Validation on Submit
      if (!/^\d{4}$/.test(codigo)) {
         msgBox.textContent = "El código debe ser un PIN de exactamente 4 dígitos numéricos.";
         showToast("El código debe ser un PIN de 4 dígitos numéricos.", "#e13333");
         return;
      }

      if (!validaCapital(nombre)) {
        showToast("El nombre debe empezar obligatoriamente con una letra mayúscula.", "#e13333");
        return;
      }
      if (!validaCapital(apellido)) {
        showToast("El apellido debe empezar obligatoriamente con una letra mayúscula.", "#e13333");
        return;
      }

      const datos = {
        nombre,
        apellido,
        codigo,
        condiciones_limitantes: condiciones,
        genero,
        edad
      };
      localStorage.setItem('pesoUsuarioTemp', peso);
      localStorage.setItem('datosPerfilUsuario', JSON.stringify(datos));
      window.location.href = "nuevo_usuario_paso2.html"; 
    }
  </script>
</body>
</html>
